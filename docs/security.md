# 🔐 Security Requirements — Astro Form

> 最終更新: 2025-06-19  
> 本ドキュメントはシステムにおけるセキュリティ要件を定義します。

---

## 1. 認証と認可

### 1.1 認証方式
- Microsoft Entra External ID（旧 Azure AD B2C）を利用した外部ID認証
- フォーム作成者（占い師・アシスタント）と運用担当者のみログインが必要
- フォーム回答者は**ログイン不要**

### 1.2 アクセス制御
| ロール     | 権限概要                                       |
|----------|---------------------------------------------|
| 占い師     | 自分のフォームの作成・編集・ログ参照が可能              |
| アシスタント | 占い師と同一のアクセス権限を持つ（ただし限定可能）        |
| 運用担当   | すべてのユーザー・フォームにアクセス可（監査／削除含む）   |

---

## 2. データ保護

### 2.1 暗号化
- Cosmos DB への保存データ（`answers` フィールド）は AES-256 で暗号化
- 暗号鍵は Azure Key Vault で管理し、定期的なローテーションを実施予定

### 2.2 通信経路の保護
- HTTPS を必須とし、全通信を TLS 1.2 以上で暗号化
- フォーム回答ページも SSL 対応

### 2.3 セッション管理
- 認証トークンは `HttpOnly + Secure` Cookie で管理（BFF構成を前提）
- アクセストークンは 1時間、リフレッシュトークンは 24時間有効

---

## 3. 脆弱性対策

### 3.1 入力値検証
- クライアント側・サーバー側の両方でバリデーションを実施
- JavaScriptインジェクション／HTMLインジェクション対策済み

### 3.2 CSRF / XSS 対策
- BFF構成により CSRF トークンを自動挿入
- 入力値は全てエスケープまたはサニタイズ処理

---

## 4. ログと監査

### 4.1 アクセスログ
- ユーザーのログイン・操作ログを Azure Application Insights へ送信
- フォーム送信履歴・エラー履歴も保存対象

### 4.2 アラート設定
- 異常ログイン・不正アクセス試行に対する Azure Monitor アラート設定

---

## 5. データ保持と削除

- フォームの回答データは最大1年間保持
- フォーム回答者からの削除依頼に対応する仕組みを準備（匿名対応可能）
- ストレージ上のファイルは期限付きURLアクセスまたは事前認証に限定

---

## 6. その他の制約・前提

- 開発・検証環境と本番環境は完全に分離
- Key Vault、Blob Storage、Cosmos DB は同一リージョンに配置しデータ越境を防止

---

