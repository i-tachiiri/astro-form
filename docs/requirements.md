## プロジェクト名

Astro form

## 関係者

- 占い師
- 占い師のアシスタント
- ユーザー
- システム運用担当
  
## 業務手順

### 占い師・占い師のアシスタント

- 占い師の**ユーザー登録**を行ってもらう
- **フォーム情報**と**デフォルトの回答項目**が設定されたフォーム作成画面へ進む
- ユーザーは**フォーム回答項目**の追加・削除・編集、**カスタム回答項目**の**回答プロパティ**の設定、**フォーム情報**の変更を行う
  - 編集中には**フォームの自動保存**がされる
  - ユーザーは**フォームの手動保存**ができる
- **フォームのプレビュー**でフォームを確認する
- **フォームの公開**をする
- フォーム一覧画面で**フォーム管理情報**を表示する
- **フォーム回答結果**を確認する
  - CSVダウンロードを可能にする

 ### ユーザー
 - **フォームの公開**で配置されたHTMLへアクセスする
   - アクセス時点で**Azure FunctionsのWarm up**を行う
- フォームを入力する
   - **入力データの一時保存**を行う
- フォームに回答する
  - 回答結果をHTMLメールで送る

### システム運用担当
- 通常のユーザーと同様にユーザー登録
- システム管理者が**運用ユーザー設定**をする
- **ログ管理ページ**を開く

### 開発担当
- Githubのdevelopブランチに変更をPR&マージ
- CI/CDで検証環境へ自動デプロイ
- 問題なければmainブランチへPR&マージし、同じく本番環境へ自動デプロイ

## 用語
- **ユーザー登録** : Microsoft Entra External IDを利用し、IDを登録してもらう事 
- **フォーム情報** : 一意のID、フォーム名、フォーム説明文、ナビゲーションテキスト、回答後ページ
- **既定のフォームコントロール** : 生まれた年・月・日はカレンダーピッカー、生まれた時・分はタイムピッカー、出生地は Places API の Autocomplete/Details で検索して取得する
- **デフォルトの回答項目** : 氏、名、メールアドレス、生まれた年・月・日、生まれた時・分、生まれた場所の国・都道府県・市町村
- **フォーム回答項目** : ユーザーが設定した回答項目。必須項目はないが、1つ以上必要
- **カスタム回答項目** : ユーザーが任意で追加できる項目。メールアドレス、年月日、時分、国、都道府県、市町村、テキスト、数値、自由入力欄
- **回答プロパティ** : 各プロパティのID、項目名、バリデーションの種類、補足説明
- **フォームの自動保存** : `blur`イベントで入力データをCosmos DBに保存、`setTimeout`で10秒入力がなかった場合にCosmos DBへ保存する事を指す。
- **フォームの手動保存** : 「下書き保存」ボタンを押し、フォームの設定項目を保存する事
- **フォーム管理情報** : フォームの名前、編集画面へのリンク、削除用ボタン、公開⇔下書きの変更ボタンを指す。公開されているフォームは回答結果ページへのリンク、公開フォームへのリンクも含む。
- **フォームの公開** : 入力フォームのデータを元にHTMLを生成し、公開フォルダ配下に配置する事。HTMLのファイル名はフォームIDで定義され、更新時は上書きされる
- **フォームのプレビュー** : 入力フォームのデータを元にHTMLを生成し、プレビュー用フォルダ配下に配置し、アクセスする事。HTMLファイルはプレビュー後に削除
- **フォーム回答結果** : フォームへの回答結果の一覧を表示したもの
- **Azure FunctionsのWarm up** : フォームの起動ログだけを残す関数を実行する事。Azure Functionsは無料枠だと常時稼働していないため、先にこれを実行してユーザーを待たせないようにする
- **入力データの一時保存** : `blur`イベントで、ローカルストレージに各プロパティのIDと入力内容をセットで保存する事。再度ページを開いた際に、各項目に値を自動入力する。
- **運用ユーザー設定** : システム管理者がMicrosoft Entra External IDで運用担当のロールを付与する事

## 画面

デザインはFluent UIをベースに行う。レスポンシブ対応。

- **ログインページ** : Microsoft Entra External IDのベーシックな機能を利用したログインページ
- **フォーム一覧画面** : 作成したフォームの一覧を表示するページ。**フォーム管理情報**を表示する
- **フォーム作成画面** : 選択したフォームの編集・公開が行えるページ
- **プレビュー画面** : 入力フォームのデータを元にHTMLを生成し、プレビュー用フォルダ配下に配置したページ
- **回答後ページ** : フォームに回答した後で遷移するページ。デフォルトではこちらで準備したThank youページが設定されており、任意のURLを設定できる。
- **ログ管理ページ** : 占い師ごと、またはフォームごとのログを参照できるページ。運用担当・開発担当だけが参照可能
- **アカウント情報ページ** : プライバシーポリシーへのリンク、ログアウト、アカウント削除
- **プライバシーポリシーのページ** : プライバシーポリシーが記載されたページ
- **アカウント削除ページ** : アカウント削除用のページ。確認後、アカウントを削除する。

  
## コンポーネント

- ヘッダー : サービス名(TOPへのリンク含む)、フォーム一覧画面、ログ管理ページ、アカウント情報ページへのリンクを含む。ログイン後は常に表示

## セキュリティ上の注意点

- フォームに入力される情報はPIIとして扱います
- 占い師・アシスタントはフォームの編集権限を持ちます。運用担当はログの参照権限を持ちます
- GDPRへの対応を行います


