## プロジェクト名

Astro form

## 関係者

- 占い師
- 占い師のアシスタント
- ユーザー
- システム運用担当

## 用語
- **ユーザー登録** : Microsoft Entra External IDを利用し、IDを登録してもらう事 
- **フォーム情報** : 一意のID、フォーム名、フォーム説明文、ナビゲーションテキスト、回答後ページ
- **既定のフォームコントロール** : 生まれた年・月・日はカレンダーピッカー、生まれた時・分はタイムピッカー、出生地は Places API の Autocomplete/Details で検索して取得する
- **デフォルトの回答項目** : 氏、名、メールアドレス、生まれた年・月・日、生まれた時・分、生まれた場所の国・都道府県・市町村
- **フォーム回答項目** : ユーザーが設定した回答項目。必須項目はないが、1つ以上必要
- **カスタム回答項目** : ユーザーが任意で追加できる項目。メールアドレス、年月日、時分、国、都道府県、市町村、テキスト、数値、自由入力欄
- **回答プロパティ** : 項目名、バリデーションの種類、補足説明
- **回答後ページ** : フォームに回答した後で遷移するページ。デフォルトではこちらで準備したThank youページが設定されており、任意のURLを設定できる。
- **フォームの自動保存** : `blur`イベントで入力データをCosmos DBに保存、`setTimeout`で10秒入力がなかった場合にCosmos DBへ保存する事を指す。
- **フォームの手動保存** : 「下書き保存」ボタンを押し、フォームの設定項目を保存する事
- **フォーム管理情報** : フォームの名前、編集画面へのリンク、削除用ボタン、公開⇔下書きの変更ボタンを指す。公開されているフォームは回答結果ページへのリンク、公開フォームへのリンクも含む。
- **フォームの公開** : 入力フォームのデータを元にHTMLを生成し、公開フォルダ配下に配置する事。HTMLのファイル名はフォームIDで定義され、更新時は上書きされる
- **フォームのプレビュー** : 入力フォームのデータを元にHTMLを生成し、プレビュー用フォルダ配下に配置し、アクセスする事。HTMLファイルはプレビュー後に削除
- **フォーム回答結果** : フォームへの回答結果の一覧を表示したもの
**Azure FunctionsのWarm up** : フォームの起動ログだけを残す関数を実行する事。Azure Functionsは無料枠だと常時稼働していないため、先にこれを実行してユーザーを待たせないようにする
  
## 業務手順

### 占い師・占い師のアシスタント

- 占い師の**ユーザー登録**を行ってもらう
- **フォーム情報**と**デフォルトの回答項目**が設定されたフォーム作成画面へ進む
- ユーザーは**フォーム回答項目**の追加・削除・編集、**カスタム回答項目**の**回答プロパティ**の設定、**フォーム情報**の変更を行う
  - 編集中には**フォームの自動保存**がされる
  - ユーザーは**フォームの手動保存**ができる
- **フォームのプレビュー**でフォームを確認する
- **フォームの公開**をする
- フォーム一覧画面で**フォーム管理情報**を表示する
- **フォーム回答結果**を確認する

 ### ユーザー
 - **フォームの公開**で配置されたHTMLへアクセスする
   - アクセス時点で**Azure FunctionsのWarm up**を行う
   - **入力データの一時保存**を行う
   - アクセスに対し一意のIDを付与し、ローカルストレージに保存
- フォームを入力する
  - `blur`イベントで入力データをCosmos DBに保存

### システム運用担当
- 通常のユーザーと同様にユーザー登録
  - Microsoft Entra External IDで運用担当のロールを付与
  - 運用担当者はナビゲーションバーの「ログ管理」メニューを表示
- ログ管理ページを開く
  - ユーザーを選択してログを表示できるようにする
  - ユーザーごとにフォームを選択してログを表示できるようにする

## 開発担当
- Githubのdevelopブランチに変更をPR&マージ
- CI/CDで検証環境へ自動デプロイ
- 問題なければmainブランチへPR&マージし、同じく本番環境へ自動デプロイ



